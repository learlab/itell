#!/bin/bash

# Enable debugging
set -x

echo "Running pre-merge-commit hook..."

# Get list of files that are marked as keep-ours
echo "Getting protected files..."
protected_files=$(git ls-files | git check-attr merge --stdin | grep "merge: keep-ours" | cut -d: -f1)
echo "Protected files:"
echo "$protected_files"

if [ -z "$protected_files" ]; then
    echo "No protected files found"
    exit 0
fi

# Get the files that were changed in this merge
echo "Getting changed files..."
changed_files=$(git diff --name-only ORIG_HEAD HEAD)
echo "Changed files:"
echo "$changed_files"

# Check each protected file
echo "$protected_files" | while read -r protected_file; do
    echo "Checking protected file: $protected_file"
    if echo "$changed_files" | grep -q "^${protected_file}$"; then
        echo "File $protected_file was changed during merge"
        echo "Restoring $protected_file from ORIG_HEAD..."
        # Restore the file from our branch (ORIG_HEAD)
        git checkout ORIG_HEAD -- "$protected_file"
        git add "$protected_file"
        echo "Restored and staged $protected_file"
    else
        echo "File $protected_file was not changed"
    fi
done

echo "Pre-merge-commit hook completed"
exit 0
