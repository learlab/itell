#!/bin/bash

# Check if we have stashed files to restore
if [ -f .git/MERGE_STASH ]; then
    echo "Restoring protected files from stash..."

    # Get the stash commit
    stash_commit=$(cat .git/MERGE_STASH)

    # Apply just the protected files from the stash
    git checkout stash@{0} -- $(git ls-files | git check-attr merge --stdin | grep "merge: keep-ours" | cut -d: -f1)

    # Add the restored files
    git add $(git ls-files | git check-attr merge --stdin | grep "merge: keep-ours" | cut -d: -f1)

    # Amend the merge commit to include the restored files
    git commit --amend --no-edit

    # Drop the temporary stash
    git stash drop

    # Clean up
    rm .git/MERGE_STASH
fi
